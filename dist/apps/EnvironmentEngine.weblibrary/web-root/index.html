<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">

  <title>webAppOS</title>

  <!-- DOJO LAYOUT PREREQUISITES -->
  <!--  <script src="dojo/dojo.js" data-dojo-config="async:1, packages: [{ name: 'jquery', location: '', main: 'jquery' }]"></script>-->

  <link rel="stylesheet" type="text/css" href="/webappos/djtheme/document.css">
  <link rel="stylesheet" type="text/css" href="/webappos/djtheme/webappos.css">
  <link rel="stylesheet" href="EnvironmentEngine.css" media="screen">
  <script src="/webappos.js"></script>

  <script src="/jquery.js"></script>

  <style id="styles">
    /*    body {
      margin: 0;
      padding: 0;
    }*/

    .nonModal_underlay {
      display: none
    }

    #eeUserMenuButton_label,
    #eeCloseButton_label {
      padding: 0px;
    }

    .closeIcon {
      background-image: url(icons/close.png);
      background-size: 100% auto;
      width: 20px;
      height: 20px;
      text-align: center;
      vertical-align: middle;
    }

    .userMenuIcon {
      background-image: url(icons/user_menu.svg);
      background-size: 100% auto;
      width: 20px;
      height: 20px;
      text-align: center;
      vertical-align: middle;
      padding-right: 0;
      margin-right: 0;
    }

    .launcherIcon {
      background-image: url(icons/launcher-icon.svg);
      background-size: 100% auto;
      width: 30px;
      height: 20px;
      text-align: center;
      vertical-align: middle;
    }
  </style>
  <!-- style for jQuery dialogs -->
  <style>
    .ui-dialog-title {
      font-size: 10pt !important;
      margin: 0 0 0 0;
    }
  </style>

  <!-- style for dojo dialogs -->
  <!--  opacity:0.0-->
  <style media="screen" type="text/css">
    .nonModal_underlay {
      display: none
    }
  </style>

  <script type="text/javascript">

    function uploadBrowseForFile(input, cmd) {
      if (input.files.length == 0) {
        alert("No file selected");
        return;
      }
      var reader = new FileReader();

      reader.onload = function (e) {
        webappos.webcall("webappos.uploadFileToCurrentProject", {
          fileName: "uploaded.browseForFile",
          content: reader.result
        }).then(function () {
          tda.model.submit(cmd); // re-launch the last cmd to process the file just uploaded
        }).then(function () {
          setTimeout(function () {
            webappos.webcall("webappos.deleteFileFromCurrentProject", "uploaded.browseForFile");
          }, 5000); // we assume that 5 seconds are enough to process the file at the server-side
        });
      };

      reader.readAsText(input.files[0]);
    }

    function saveIndex(index) {
      // save index
      webappos.webcall("webappos.uploadFileToCurrentProject", {
        fileName: "fordownload.index",
        content: index + ""
      }).then(() => tda.model.submit(window.relaunch_cmd));
    }

    function parseExtension(filter, index) {
      if (typeof index === 'string') {
        try {
          index = parseInt(index);
        } catch (t) {
          index = 0;
        }
      }

      var ext = "txt";
      filter = filter.split("\n");

      if (filter && (index >= 0) && (index < filter.length)) {
        filter = filter[index];
        var i = filter.indexOf("(*.");
        if (i >= 0) {
          var j = filter.indexOf(")", i + 3);
          if (j >= 0)
            ext = filter.substring(i + 3, j);
        }
      }

      return ext;
    }

    function browseForFile_download(ext) {
      // wait for file content...
      var steps = 10;
      var f = function () {
 
        webappos.webcall("webappos.getFileContentFromCurrentProjectAsUTF8String", "fordownload.browseForFile").then(
          function (result) {
            if (!result.content) {
              steps--;
              if (steps > 0) {
                setTimeout(f, 1500);                
              }
              return;
            } else {
              // ok, file content read...
              webappos.webcall("webappos.deleteFileFromCurrentProject", "fordownload.browseForFile");
              webappos.webcall("webappos.deleteFileFromCurrentProject", "fordownload.index");

              var element = document.createElement('a');
              element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(result.content));
              element.setAttribute('download', "download." + ext);

              element.style.display = 'none';
              document.body.appendChild(element);

              element.click();

              document.body.removeChild(element);
            }
          }); // then
      };
      f();
      return {};
    }

    function browseForFile_index(filter) {
      var cmd = new tda.model[tda.model.last_submitted.className]();
      for (var attr in tda.model.last_submitted) {
        if ((attr != "reference") && (attr != "className") && (attr != "classes"))
          cmd["set" + webappos.js_util.capitalize_first_letter(attr)](tda.model.last_submitted[attr]);
      }
      window.relaunch_cmd = cmd; // for re-launching

      // choose index...
      let arr = filter.split("\n");
      var contentStr = "";
      contentStr += "<style>" +
        ".fullWidthButton {" +
        "  width:100%;" +
        "}" +
        ".fullWidthButton .dijitButtonNode {" +
        "  width :calc(100% - 16px);" +
        "}" +
        "<\/style>";
      for (var i = 0; i < arr.length; i++) {
        contentStr +=
          "<button class=\"fullWidthButton\" data-dojo-type=\"dijit/form/Button\" type=\"button\">" + arr[i] +
          "   <script type=\"dojo/on\" data-dojo-event=\"click\" data-dojo-args=\"evt\" style=\"width:100%;\">" +
//          "       saveIndex(" + i + "); browseForFile_download(parseExtension(\""+filter.split("\n").join("\\n")+"\", "+i+")); myDialog.destroy();" +
          "       saveIndex(" + i + "); myDialog.destroy();" +
          "   <\/script>" +
          "<\/button>";
      }

      contentStr +=
        "<div style=\"text-align: center\">" +
        "<button data-dojo-type=\"dijit/form/Button\" type=\"button\">Cancel" +
        "   <script type=\"dojo/on\" data-dojo-event=\"click\" data-dojo-args=\"evt\">" +
        "       myDialog.destroy();" +
        "   <\/script>" +
        "<\/button>" +
        "<\/div>";

      require(["dijit/Dialog", "dojo/domReady!"], function (Dialog) {
        myDialog = new Dialog({
          id: "myDialog",
          title: "Download file as",
          content: contentStr,
          style: "width: 400px"
        });
        myDialog.show();
      });
      return {};
    }


    function browseForFileToUpload(filter) {
      var cmd = new tda.model[tda.model.last_submitted.className]();
      for (var attr in tda.model.last_submitted) {
        if ((attr != "reference") && (attr != "className") && (attr != "classes"))
          cmd["set" + webappos.js_util.capitalize_first_letter(attr)](tda.model.last_submitted[attr]);
      }
      window.relaunch_cmd = cmd; // for re-launching

      require(["dijit/Dialog", "dojo/domReady!"], function (Dialog) {
        myDialog = new Dialog({
          id: "myDialog",
          title: "Upload file",
          content: "<form action='fileupload' method='post' enctype='multipart/form-data'>" +
            "<input id='inner_input' type='file' name='uploaded_file'/>" +
            "<input id='inner_submit' type='button' onclick='uploadBrowseForFile(inner_input,window.relaunch_cmd); myDialog.destroy();' value='Upload'/>" +
            "</form>",
          style: "width: 400px"
        });
        myDialog.show();
      });

      return {};
    }

    function browseForFolder(json) {

      var cmd = new tda.model[tda.model.last_submitted.className]();
      for (var attr in tda.model.last_submitted) {
        if ((attr != "reference") && (attr != "className") && (attr != "classes"))
          cmd["set" + webappos.js_util.capitalize_first_letter(attr)](tda.model.last_submitted[attr]);
      }
      window.relaunch_cmd = cmd; // for re-launching

      webappos.desktop.browse_for_file("dir").then(function (dirName) {

        if (typeof dirName == "string") {
          webappos.webcall("webappos.uploadFileToCurrentProject", {
            fileName: "selected.browseForFolder",
            content: dirName + ""
          }).then(function () {
            tda.model.submit(window.relaunch_cmd);
          });
        } else {
          webappos.webcall("webappos.uploadFileToCurrentProject", {
            fileName: "cancelled.browseForFolder",
            content: ""
          }).then(function () {
            tda.model.submit(window.relaunch_cmd);
          });
        }

      });

      return {};
    }

    function selectListDirectory(dir) {
      // save dir
      webappos.webcall("webappos.uploadFileToCurrentProject", {
        fileName: "selected.browseForFolderAsList",
        content: dir + ""
      }).then(() => tda.model.submit(window.relaunch_cmd));
    }

    function cancelListDirectory() {
      // save dir
      webappos.webcall("webappos.uploadFileToCurrentProject", {
        fileName: "cancelled.browseForFolderAsList",
        content: ""
      }).then(() => tda.model.submit(window.relaunch_cmd));
    }


    function browseForFolderAsList(json) {
      if (typeof json == "string")
        json = JSON.parse(json);
      var cmd = new tda.model[tda.model.last_submitted.className]();
      for (var attr in tda.model.last_submitted) {
        if ((attr != "reference") && (attr != "className") && (attr != "classes"))
          cmd["set" + webappos.js_util.capitalize_first_letter(attr)](tda.model.last_submitted[attr]);
      }
      window.relaunch_cmd = cmd; // for re-launching

      // choose index...
      var contentStr = "<style>" +
        ".fullWidthButton {" +
        "  width:100%;" +
        "}" +
        ".fullWidthButton .dijitButtonNode {" +
        "  width :calc(100% - 16px);" +
        "}" +
        "<\/style>";
      for (var i = 0; i < json.items.length; i++) {
        contentStr +=
          "<button class=\"fullWidthButton\" data-dojo-type=\"dijit/form/Button\" type=\"button\">" + json.items[i] +
          "   <script type=\"dojo/on\" data-dojo-event=\"click\" data-dojo-args=\"evt\" style=\"width:100%;\">" +
          "       selectListDirectory(\"" + json.items[i] + "\"); myDialog.destroy();" +
          "   <\/script>" +
          "<\/button>";
      }

      contentStr +=
        "<div style=\"text-align: center\">" +
        "<button data-dojo-type=\"dijit/form/Button\" type=\"button\">Cancel" +
        "   <script type=\"dojo/on\" data-dojo-event=\"click\" data-dojo-args=\"evt\">" +
        "       cancelListDirectory(); myDialog.destroy();" +
        "   <\/script>" +
        "<\/button>" +
        "<\/div>";

      require(["dijit/Dialog", "dojo/domReady!"], function (Dialog) {
        myDialog = new Dialog({
          id: "myDialog",
          title: json.caption,
          content: contentStr,
          style: "width: 400px"
        });
        myDialog.show();
      });
      return {};
    }


    var lastPleaseWait = {};
    function showPleaseWait(json) {
      if (typeof json == "string") {
        try {
          json = JSON.parse(json);
        }
        catch(t) {
          json = {};
        }
      }
      if (!json)
        json = {};
      

      console.log(json, json.message, json.percentage);
      var lastmsg = ((typeof lastPleaseWait.message!="undefined")?lastPleaseWait.message:"")+((typeof lastPleaseWait.percentage!="undefined")?" ("+lastPleaseWait.percentage+"%)":"");

      if (json.message)
        lastPleaseWait.message = json.message;
      else
      if (!lastPleaseWait.message)
        lastPleaseWait.message = "Please, wait";

      if (typeof json.percentage!="undefined")
        lastPleaseWait.percentage = json.percentage;

      var msg = ((typeof lastPleaseWait.message!="undefined")?lastPleaseWait.message:"")+((typeof lastPleaseWait.percentage!="undefined")?" ("+lastPleaseWait.percentage+"%)":"");
      if (msg!=lastmsg) {
        webappos.js_util.show_please_wait(msg);
      }
    }

    function hidePleaseWait() {
      lastPleaseWait = {};
      webappos.js_util.hide_please_wait();
    }
    //    <!-- ENVIRONMENT ENGINE COMMAND HANDLERS -->

    var activeDojoFrame; // undefined in the beginning

    function showContainer(container) {
      container.domNode.style.display = 'block';
      container.resize();
    }

    function hideContainer(container) {
      container.domNode.style.display = 'none';
      container.resize();
    }

    var frames = {};

    function attachFrameInRepository(reference) {
      if (reference <= 0)
        return;
      var ee = tda.model.EnvironmentEngine.getFirstObject();
      tda.model[reference].setEnvironmentEngine(ee);
      delete frames["loading" + reference];
    }

    function detachFrameInRepository(reference, permanently) {
      if (reference <= 0)
        return;
      delete frames["frame" + reference];
      var frame = tda.model[reference]; // the frame might already be deleted
      if (frame) {
        frame.setEnvironmentEngine([]);
        if (permanently)
          frame.delete();
      }
    }

    function getFrameDiv(navigation) {
      if (navigation.indexOf("[") >= 0) { // navigation may contain something like [800x600]...
        navigation = navigation.substring(0, navigation.indexOf("["));
      }
      var iframes = navigation.split(".");
      var f;


      if ((iframes[0].indexOf("iframe") != 0) && (iframes[0].indexOf("jqueryFrame") != 0)) {
        f = document.getElementById("iframe" + iframes[0]);
        if (!f)
          f = document.getElementById("jqueryFrame" + iframes[0]);
        iframes.shift();
      } else {
        f = document.getElementById(iframes[0]);
        iframes.shift();
      }

      while ((f) && (iframes.length > 0)) {
        if (f.contentWindow) {
          f = f.contentWindow[iframes[0]];
        } else { // IE
          f = f.frameElement.contentWindow[iframes[0]];
        }
        iframes.shift();
      }

      return f;
    }

    function attachFrame(location, contentURI, caption, reference, isClosable) {
      if (frames["frame" + reference]) {
        delete frames["frame" + reference];
        detachFrameInRepository(reference);
      }

      if (frames["loading" + reference]) {
        return;
      }

      frames["loading" + reference] = true;

      var innerhtml = false;
 
      if (contentURI.indexOf("innerhtml:") == 0) {
        innerhtml = true;
        contentURI = contentURI.substring(10);
      } else
      if (contentURI.indexOf("html:") == 0) {
        contentURI = contentURI.substring(5);
      } else
        return;

      if (!caption)
        caption = "";

      var style = null;

      if (location.substr(0, 9) == "framediv:") {

        i = location.indexOf("(");
        j = location.indexOf(")");
        if ((i >= 0) && (j > i)) {
          location = location.substring(0, i) + location.substring(j + 1);
        }

        var dim = null;
        i = location.indexOf("[");
        j = location.indexOf("]");
        if ((i >= 0) && (j > i)) {
          dim = location.substring(i + 1, j);
          location = location.substring(0, i) + location.substring(j + 1);
        }

        var frameDiv = getFrameDiv(location.substring(9));

        if (dim) {
          i = dim.indexOf("*");
          if (i < 0)
            i = dim.indexOf("x");
          if (i >= 0) {
            /*             var width = dim.substring(0, i).trim();
                         var height = dim.substring(i + 1).trim();
                         if (width.length > 0) {
                           $(frameDiv).width(parseInt(width));
                         }
                         if (height.length > 0) {
                           $(frameDiv).height(parseInt(height));
                         }*/
          }
        }


        // We use the following code to add an iframe to the ContentPane:
        var iframe = dojo.create("iframe", {
          "id": "iframe" + reference,
          "src": contentURI,
          //           "style": "border: 0; margin:0; padding:0; width: "+$(frameDiv).width()+"; height:"+$(frameDiv).height()+";"
          "style": "border: 0; margin:0; padding:0; width: 100%; height:100%;"
        });


        if (iframe.attachEvent) {
          iframe.attachEvent("onload", function () {
            frames["frame" + reference] = 'loaded';
            attachFrameInRepository(reference);
          });
        } else {
          iframe.onload = function () {
            frames["frame" + reference] = 'loaded';
            attachFrameInRepository(reference);
          };
        }

        require(["jquery"], function ($) {
          $(frameDiv).wrapInner("<div style='display:none;'></div>");
          frameDiv.appendChild(iframe);
        });
      } else
      if ((location.indexOf("popup") == 0) || (location.indexOf("modalpopup") == 0)) {

        var hidden = false;
        // POPUP
        i = location.indexOf("[");
        j = location.indexOf("]");
        if ((i >= 0) && (j > i)) {
          var dim = location.substring(i + 1, j);
          location = location.substring(0, i) + location.substring(j + 1);
          i = dim.indexOf("*");
          if (i < 0)
            i = dim.indexOf("x");
          if (i >= 0) {
            var width = dim.substring(0, i).trim();
            var height = dim.substring(i + 1).trim();

            style = "";

            if ((width=="0") || (height=="0"))
              hidden = true;
            else {
              if (parseInt(width,10)==width) width+="px"; // add "px" if raw integer
              if (parseInt(height,10)==height) height+="px"; // add "px" if raw integer
              if (width.length > 0)
                style += "width:" + width+";";

              if (height.length > 0)
                style += "height:" + height+";";
            }
          }
        
        } else
          style = "width: 30%; height:40%";

        i = location.indexOf("(");
        j = location.indexOf(")");
        if ((i >= 0) && (j > i)) {
          var dim = location.substring(i + 1, j);
          location = location.substring(0, i) + location.substring(j + 1);
          i = dim.indexOf(",");
          if (i < 0)
            i = dim.indexOf(";");
          if (i >= 0) {
            var x = dim.substring(0, i);
            var y = dim.substring(i + 1);
            if (!style) {
              style = "";
            } else
              style += ";";

            if ((x.trim().length > 0) && (x != "undefined"))
              style += "left:" + x + ";";
            if ((y.trim().length > 0) && (y != "undefined"))
              style += "top:" + y;
          }
        }

        require(["dijit/Dialog", "dojo/on", "dojo/domReady!"], function (Dialog, on) {

          //  style = "width: 300;"+style;

          style = "padding:0; background-color: #ffffff; " + style;

          //      var styleObj = JSON.parse("{"+style+"}");

          if (innerhtml) {
            var popupDialog = new Dialog({
              id: "frame" + reference,
              title: caption, //,
              class: hidden?"dijitHidden":"",
              //class: 'nonModal'
              //          width: styleObj.width,
              style: style
            });

            if (location.indexOf("popup") == 0) {
              // non-modal
              popupDialog.set("class", 'nonModal');
            }

            if (isClosable == false) {
              popupDialog.set("closable", false);
            }

            popupDialog.closable = false;


            if (style)
              popupDialog.set("style", style);

            popupDialog.set("content", contentURI);
            dojo.connect(popupDialog, "onLoad", function () {
              frames["frame" + reference] = 'loaded';
              attachFrameInRepository(reference);

              //if (style.indexof("display:none;")>=0)
                //popupDialog.hide();
            });

            alert(style.indexOf("display:none;"));
            if (style.indexOf("display:none;")<0)
              popupDialog.show();
          } else {

            // variant 1 (with jQuery):

            /*		
                      $("#body").append("<div id='jqueryFrame"+reference+"'><iframe style=' border:0; width:100%; height:100%' src='"+contentURI+"' id='iframe"+reference+"'></iframe></div>");
                      $(document).ready(function() {
  
                        $( "#jqueryFrame"+reference ).dialog({
                          title: caption,
                          autoOpen: false,
                          width: 400,
                          height: 300,
                          buttons: {
                          }
                        });
                        $( "#jqueryFrame"+reference ).dialog( "open" );
  
                        var iframe = document.getElementById('iframe'+reference);
                        if (iframe.attachEvent){
                            iframe.attachEvent("onload", function(){
                                frames["frame"+reference] = 'loaded';
                            });
                        } else {
                            iframe.onload = function(){
                                frames["frame"+reference] = 'loaded';
                            };
                        }
                      });
              */

            // variant 2 (with dojo):


            var popupDialog = new Dialog({
              id: "frame" + reference,
              title: caption, 
              class: hidden?"dijitHidden":"",
            });

            if (style)
              popupDialog.set("style", style);

            if (location.indexOf("popup") == 0) {
              // non-modal
              popupDialog.set("class", 'nonModal');
            }

            if (!isClosable) {
              popupDialog.set("closable", false);
            }

            // We use the following code to add an iframe to the ContentPane:
            var iframe = dojo.create("iframe", {
              "id": "iframe" + reference,
              "src": contentURI,
              "style": "border: 0; margin:0; padding:0; width: 100%; height:100%;"
            });


            popupDialog.set("content", iframe);
            //        popupDialog.set("href", contentURI);

            if (iframe.attachEvent) {
              iframe.attachEvent("onload", function () {
                frames["frame" + reference] = 'loaded';
                attachFrameInRepository(reference);
              });
            } else {
              iframe.onload = function () {
                frames["frame" + reference] = 'loaded';
                attachFrameInRepository(reference);
              };
            }



            $("#frame" + reference).css(".nonModal_underlay {display:none}");
            $("#frame" + reference).css(".dijitDialogCloseIcon", "display: none;");

            on(popupDialog, "hide", function (e) {
              on(popupDialog, "hide", function (e) {});

              //              popupDialog.show(); // to finish some actions with the frame...
              var ev = new tda.model.CloseFrameRequestedEvent();
              ev.setForce(true);
              ev.setFrame(tda.model[reference]);
              tda.model.submit(ev);

              // !!!DO NOT call popupDialog.destroy();
              // !!!This is needed since some actions may need to be finished
              // !!!within the frame...
            });
            on(popupDialog, "show", function (e) {
              iframe.style.height = (popupDialog.domNode.clientHeight - 50) + "px";
            });

            popupDialog.show();
            popupDialog._setStyleAttr('left:' + x + 'px;');
            popupDialog._setStyleAttr('top:' + y + 'px;');


          } // else
        }); // require

        return;
      } else
        // NON-POPUP
        require(["dijit/registry", "dijit/layout/BorderContainer", "dijit/layout/TabContainer",
            "dojox/layout/ContentPane", "dojo/dom-construct", "dijit/Dialog", "dijit/form/Button", "dojo/on", "dojo/domReady!"
          ],
          function (registry, BorderContainer, TabContainer, ContentPane, domConstruct, Dialog, Button, on) {
            var container = centerContainer;
            if ("left".localeCompare(location) == 0)
              container = leftContainer;
            else if ("right".localeCompare(location) == 0)
              container = rightContainer;
            else if ("top".localeCompare(location) == 0)
              container = topContainer;
            else if ("bottom".localeCompare(location) == 0)
              container = bottomContainer;


            console.log("Registering FRAME frame"+reference);
            var frame = new ContentPane({
              //        href: contentURI,  // -- this would be needed when not using iframes
              title: caption,
              id: "frame" + reference,
              style: "padding:0;",
            });

            if (isClosable == true) {
              frame.set("closable", true);
              on(frame, "close", function (e) {
                var event = new tda.model.CloseFrameRequestedEvent();
                event.setForce(true);
                event.setFrame(tda.model[reference]);
                tda.model.submit(event);
                return false; // we do not close the frame; it must be closed by the server-side
                // code via issuing DetachFrameCommand
              });
            } else {
              frame.set("closable", false);
            }


            container.watch("selectedChildWidget", function (name, oval, nval) {

              if (activeDojoFrame == nval)
                return;

              if (oval) {
                // deactivating event...
                var frame = tda.model[parseInt(oval.id.substring(5))];  // remove the "frame" prefix
                if (frame) {
                  var event = new tda.model.FrameDeactivatingEvent();
                  event.setFrame(frame);
                  tda.model.submit(event);
                }

              }

              activeDojoFrame = nval;
              if (nval) {
                if (parseInt(nval.id.substring(5)) >= 0) {
                  var event = new tda.model.FrameActivatedEvent();
                  event.setFrame(tda.model[parseInt(nval.id.substring(5))]);
                  tda.model.submit(event);

                  /*                    var ee = tda.model.EnvironmentEngine.getFirstObject();
                                      var rocmd = new tda.model.RefreshOptionsCommand();
                                      rocmd.setEnvironmentEngine(ee);
                                      tda.model.submit(rocmd);*/
                }
              }

            });

            container.addChild(frame);

            if (container.getChildren().length == 1) {
              // the child has been added to an empty (and, thus, invisible) container; showing it...
              showContainer(container);
            }

            container.selectChild(frame);

            if (innerhtml) {
              frame.set("content", contentURI);
              dojo.connect(frame, "onLoad", function () {
                frames["frame" + reference] = 'loaded';
                attachFrameInRepository(reference);
              });
            } else {

              // We use the following code to add an iframe to the ContentPane:
              frame.set("content", dojo.create("iframe", {
                "id": "iframe" + reference,
                "src": contentURI,
                "style": "border: 0; width: 100%; height: 99%"
              }));

              var iframe = document.getElementById('iframe' + reference);

              if (iframe.attachEvent) {
                iframe.attachEvent("onload", function () {
                  frames["frame" + reference] = 'loaded';
                  attachFrameInRepository(reference);
                });
              } else {
                iframe.onload = function () {
                  frames["frame" + reference] = 'loaded';
                  attachFrameInRepository(reference);
                };
              }
            }

          }); // require

    }

    function whenFrameLoaded(reference, callback) {
      var ee = tda.model[reference].getEnvironmentEngine();
      if (!ee || (ee.length == 0)) {
        var frame = tda.model[reference];
        attachFrame(frame.location, frame.contentURI, frame.caption, reference, (frame.isClosable == true) || (frame
          .isClosable == 'true'));
      }

      var interval = 10; // ms
      window.setTimeout(function () {
        if (frames["frame" + reference]) {
          callback();
        } else {
          window.setTimeout(arguments.callee, interval);
        }
      }, interval);
    }

    function executeSerializedAttachFrameCommand(commandJSON) {
      require(["dijit/registry", "dijit/layout/BorderContainer", "dijit/layout/TabContainer",
          "dojox/layout/ContentPane", "dojo/domReady!"
        ],
        function (registry, BorderContainer, TabContainer, ContentPane) {
          if (!commandJSON.frame[0].location)
            commandJSON.frame[0].location = "center";

          if (typeof commandJSON.frame[0].isClosable === 'undefined')
            commandJSON.frame[0].isClosable = true;

          attachFrame(commandJSON.frame[0].location, commandJSON.frame[0].contentURI, commandJSON.frame[0].caption,
            commandJSON.frame[0].reference, (commandJSON.frame[0].isClosable == true) || (commandJSON.frame[0]
              .isClosable == 'true'));
        });
    }

    function executeAttachFrameCommand(cmd) {
      require(["dijit/registry", "dijit/layout/BorderContainer", "dijit/layout/TabContainer",
          "dojox/layout/ContentPane", "dojo/domReady!"
        ],
        function (registry, BorderContainer, TabContainer, ContentPane) {
          var frame = cmd.getFrame()[0];
          if (!frame.location)
            frame.location = "center";

          if (typeof frame.isClosable === 'undefined')
            frame.isClosable = true;

          attachFrame(frame.location, frame.contentURI, frame.caption, frame.reference, frame.isClosable);
        });
    }

    function finalizeIFrame(f) {
      if (f) {
        if (f.contentWindow) {
          if (f.contentWindow.finalize) {
            f.contentWindow.finalize();
          }
          // the finalize() function may be implemented in the inner html file
        } else { // IE
          if (f.frameElement.contentWindow.finalize)
            f.frameElement.contentWindow.finalize();
          // the finalize() function may be implemented in the inner html file
        }
      }
    }

    function executeSerializedDetachFrameCommand(commandJSON) {
      require(["dijit/registry", "dijit/layout/BorderContainer", "dijit/layout/TabContainer",
          "dojox/layout/ContentPane", "dojo/domReady!"
        ],
        function (registry, BorderContainer, TabContainer, ContentPane) {
          var fff = function () {
            var reference = commandJSON.frame[0].reference;
            var frame = registry.byId("frame" + reference);

            if (typeof frame != 'undefined') {
              if (frame && (frame.destroy)) {
                // This is a dojo frame...
                if (commandJSON.permanently == false) {
                  frame.getParent().removeChild(frame);
                  frame.hide();
                  detachFrameInRepository(commandJSON.frame[0].reference);
                } else {
                  var f = document.getElementById("iframe" + commandJSON.frame[0].reference);
                  finalizeIFrame(f);

                  setTimeout(function () {
                    setTimeout(function () {
                      setTimeout(function () {
                        setTimeout(function () {
                          setTimeout(function () {
                            if (frames["frame" + commandJSON.frame[0].reference])
                              delete frames["frame" + commandJSON.frame[0].reference];
                            if (frame.getParent())
                              frame.getParent().removeChild(frame);
                            frame.destroy();
                            detachFrameInRepository(commandJSON.frame[0].reference);

                          }, 0);
                        }, 0);
                      }, 0);
                    }, 0);
                  }, 0);
                }
              } else {
                alert("Invalid dojo frame - " + reference);
              }
            } else
            if (document.getElementById("jqueryFrame" + reference)) {
              // This is a JQuery frame...
              finalizeIFrame(document.getElementById("jqueryFrame" + reference));
              setTimeout(function () {
                setTimeout(function () {
                  setTimeout(function () {
                    setTimeout(function () {
                      setTimeout(function () {
                        $("#jqueryFrame" + reference).dialog("close");
                        $("#jqueryFrame" + reference).remove();
                        detachFrameInRepository(reference);
                      }, 0);
                    }, 0);
                  }, 0);
                }, 0);
              }, 0);
            } else {
              // perhaps, this is a framediv...
              if (commandJSON.frame[0].location.substr(0, 9) == "framediv:") {
                var frameDiv = getFrameDiv(commandJSON.frame[0].location.substring(9));
                if (frameDiv) {
                  var iframe = frameDiv.lastChild;
                  if (iframe) {
                    finalizeIFrame(iframe);
                  }
                  setTimeout(function () {
                    setTimeout(function () {
                      setTimeout(function () {
                        setTimeout(function () {
                          setTimeout(function () {
                            if (iframe && (iframe.parentNode == frameDiv)) {
                              frameDiv.removeChild(iframe);
                              frameDiv.innerHTML = frameDiv.firstChild
                                .innerHTML; // unwrapping div
                              detachFrameInRepository(commandJSON.frame[0].reference);
                            }
                          }, 0);
                        }, 0);
                      }, 0);
                    }, 0);
                  }, 0);
                }
              }
            }
          };

          // detaching frame in fff() after the JavaScript queue is emptied (the queue may contain its own
          // delayed setTimeout-s to max depth 2)
          //          setTimeout(function() {
          //            setTimeout(function() {
          fff();
          //            }, 0);
          //          }, 0);
        });
    }

    function detachFrame(reference, permanently) {
      require(["dijit/registry", "dijit/layout/BorderContainer", "dijit/layout/TabContainer",
          "dojox/layout/ContentPane", "dojo/domReady!"
        ],
        function (registry, BorderContainer, TabContainer, ContentPane) {
          var fff = function () {
            var frame = registry.byId("frame" + reference);

            if (typeof frame != 'undefined') {
              if (frame && (frame.destroy)) {
                // This is a dojo frame...
                if (permanently == false) {
                  frame.getParent().removeChild(frame);
                  frame.hide();
                  detachFrameInRepository(reference);
                } else {

                  $(frame).addClass("dijitHidden");                  
                  var f = document.getElementById("iframe" + reference);
                  finalizeIFrame(f);

                  setTimeout(function () {
                    setTimeout(function () {
                      setTimeout(function () {
                        setTimeout(function () {
                          setTimeout(function () {

                            if (frames["frame" + reference])
                              delete frames["frame" + reference];
                            if (frame.getParent())
                              frame.getParent().removeChild(frame);
                            frame.destroy();
                            detachFrameInRepository(reference, permanently);

                          }, 0);
                        }, 0);
                      }, 0);
                    }, 0);
                  }, 0);
                }
              } else {
                alert("Invalid dojo frame - " + reference);
              }
            } else
            if (document.getElementById("jqueryFrame" + reference)) {
              // This is a JQuery frame...
              finalizeIFrame(document.getElementById("jqueryFrame" + reference));
              setTimeout(function () {
                setTimeout(function () {
                  setTimeout(function () {
                    setTimeout(function () {
                      setTimeout(function () {
                        $("#jqueryFrame" + reference).dialog("close");
                        $("#jqueryFrame" + reference).remove();
                        detachFrameInRepository(reference);
                      }, 0);
                    }, 0);
                  }, 0);
                }, 0);
              }, 0);
            } else {
              // perhaps, this is a framediv...
              if (cmd.frame[0].location.substr(0, 9) == "framediv:") {
                var frameDiv = getFrameDiv(cmd.frame[0].location.substring(9));
                if (frameDiv) {
                  var iframe = frameDiv.lastChild;
                  if (iframe) {
                    finalizeIFrame(iframe);
                  }
                  setTimeout(function () {
                    setTimeout(function () {
                      setTimeout(function () {
                        setTimeout(function () {
                          setTimeout(function () {
                            if (iframe && (iframe.parentNode == frameDiv)) {
                              frameDiv.removeChild(iframe);
                              frameDiv.innerHTML = frameDiv.firstChild
                                .innerHTML; // unwrapping div
                              detachFrameInRepository(reference);
                            }
                          }, 0);
                        }, 0);
                      }, 0);
                    }, 0);
                  }, 0);
                }
              }
            }
          };

          // detaching frame in fff() after the JavaScript queue is emptied (the queue may contain its own
          // delayed setTimeout-s to max depth 2)
          //          setTimeout(function() {
          //            setTimeout(function() {
          fff();
          //            }, 0);
          //          }, 0);
        });
    }

    function executeDetachFrameCommand(cmd) {
      console.log("DETACH ",cmd);
      var f = cmd.frame[0];
      console.log(f);

      // deleting frame-specific options...
      var arr = f.getOption();
      for (var i = 0; i < arr.length; i++) {
        arr[i].delete();
      }

      detachFrame(cmd.frame[0].reference, cmd.permanently);
    }

    function promptProjectNameAndOpen(uri, defaultName) {
      var answer = prompt("Enter the project name, please:", defaultName);
      if (!answer)
        return;
      //      alert(uri +"#"+defaultName);
      window.location = uri + ":" + answer;
    }

    function executeSerializedPostMessageToFrameCommand(commandJSON) {


      require(["dojox/layout/ContentPane", "dijit/registry", "webappos.js", "dojo/domReady!"], function (ContentPane,
        registry) {

        var frame = registry.byId("frame" + commandJSON.frame[0].reference);

        if (commandJSON.messageURI.indexOf("javascript:") != 0)
          return;

        commandJSON.messageURI = commandJSON.messageURI.substring(11);

        if (frame.getParent()) {
          frame.getParent().selectChild(frame);
        }


        whenFrameLoaded(commandJSON.frame[0].reference, function () {
          var iframe = document.getElementById('iframe' + commandJSON.frame[0].reference);
          if (iframe) {
            if (iframe.contentWindow)
              iframe.contentWindow["eval"](commandJSON.messageURI);
            else
            if (iframe.frameElement)
              iframe.frameElement.contentWindow["eval"](commandJSON.messageURI);
          } else
            alert("error evaluating " + JSON.stringify(commandJSON));

          // if we were not using iframes, we would have to find some other mechanism...

        });

      });
    }

    function executePostMessageToFrameCommand(cmd) {

      require(["dojox/layout/ContentPane", "dijit/registry", "/webappos.js", "dojo/domReady!"], function (ContentPane,
        registry) {
        var cmdFrame = cmd.getFrame()[0];

        var frame = registry.byId("frame" + cmdFrame.reference);

        if (cmd.messageURI.indexOf("javascript:") != 0)
          return;

        let messageURI = cmd.messageURI.substring(11);
        console.log("EE PostMessage",messageURI.length, messageURI);
        cmd.delete();

        if (frame.getParent()) {
          frame.getParent().selectChild(frame);
        }


        whenFrameLoaded(cmdFrame.reference, function () {
          var iframe = document.getElementById('iframe' + cmdFrame.reference);
          if (iframe) {
            if (iframe.contentWindow)
              iframe.contentWindow["eval"](messageURI);
            else
            if (iframe.frameElement)
              iframe.frameElement.contentWindow["eval"](messageURI);
          } else
            alert("error evaluating command");

          // if we were not using iframes, we would have to find some other mechanism...

        });

      });
    }

    function searchForFrameDirect(cmd) {
      for (var i = 0; i < cmd.classes.length; i++) {
        var assocs = cmd.classes[i].getAllAssociations();
        for (var assocId in assocs) {
          var assoc = assocs[assocId];
          if (assoc.targetClass.className == "Frame") {
            if (cmd[assoc.roleName] && (cmd[assoc.roleName].length > 0)) {
              return cmd[assoc.roleName][0];
            }
          }
        }
      }

      if (cmd["container"] && (cmd["container"].length > 0)) {
        var retVal = searchForFrameDirect(cmd["container"][0]);
        if (retVal)
          return retVal;
      }
      return null;
    }

    function searchForFrame(cmd) {

      var retVal = searchForFrameDirect(cmd);
      if (retVal)
        return retVal;
      // search in linked objects...
      for (var i = 0; i < cmd.classes.length; i++) {
        var assocs = cmd.classes[i].getAllAssociations();
        for (var assocId in assocs) {
          var assoc = assocs[assocId];
          if (cmd[assoc.roleName]) {
            for (var j = 0; j < cmd[assoc.roleName].length; j++) {
              retVal = searchForFrameDirect(cmd[assoc.roleName][j]);
              if (retVal)
                return retVal;
            }
          } else {}
        }
      }
      return null;
    }

    // redefining...
    console.log("REDEFINING GET_WIN...");
    window.webappos.get_client_webcall_window = async function(actionName, arg) {
      console.log("IN REDEFINED GET_WIN");
      var p = new Promise(async function (resolve, reject) {
        require(["dojox/layout/ContentPane", "dijit/registry", "/webappos.js", "dojo/domReady!"], function (ContentPane,
        registry) {

          var frameReference = 0;

          if (arg && arg.reference) { // webmem argument
            if ((arg.getClassName() == "AttachFrameCommand") || (arg.getClassName() == "DetachFrameCommand") || (arg.getClassName() == "PostMessageToFrameCommand") || (arg.getClassName() == "RefreshOptionsCommand")) {
              // always execute these commands in the main window
              return resolve(window);
            }
            else {
              // trying to get the frame reference anyway...
                var argFrame = searchForFrame(arg);
                if (argFrame) {
                  frameReference = argFrame.reference;
                }
            }
          }
          else { // non webmem argument
            let ok = true;

            if (typeof arg == "string") {
              try {
                arg = eval("("+arg+")");
              }
              catch(t) {
                console.log(t);
                ok = false;
              }
            }

            if ((actionName == "executeRefreshOptionsCommand") || (actionName=="executeAttachFrameCommand") || (actionName=="executeDetachFrameCommand") || (actionName=="executePostMessageToFrameCommand") ){
              // always execute these commands in the main window
              return resolve(window);
            }

            if (ok) {
              if (frameReference==0) {
                if (arg && arg.frameReference)
                  frameReference = arg.frameReference;
              }
              if (frameReference==0) {
                if (arg && arg.frame && arg.frame.reference)
                  frameReference = arg.frame.reference;
              }
              if (frameReference==0) {
                if (arg && arg.frame && arg.frame[0] && arg.frame[0].reference)
                  frameReference = arg.frame[0].reference;
              }
            }
          }

          if (frameReference!=0) {

              console.log("EnvironmentEngine: Found inner frame " + frameReference+"!");
              whenFrameLoaded(frameReference, function () {
                var frame = registry.byId("frame" + frameReference);
                /*if (frame.getParent()) {
                  frame.getParent().selectChild(frame);
                }*/
                var iframe = document.getElementById('iframe' + frameReference);
                if (iframe) {
                  if (iframe.contentWindow) {
                    resolve(iframe.contentWindow);
                    return;
                  } 
                  else {
                    if (iframe.frameElement) {
                      resolve(iframe.frameElement.contentWindow);
                      return;
                    }
                  }
                } else {
                  console.log("EnvironmentEngine: iframe with DOM ID frame"+frameReference+" not found, trying in the main window.");
                  resolve(window);
                }
              }); // whenFrameLoaded

          } // if frameReference
          else {
              console.log("EnvironmentEngine: Could not detetermine/find the inner frame for a client-side webcall "+actionName+", assuming the main window.",arg);
              resolve(window);
          }





        }); // require

      }); // promise
      return p;
    };


          function resizeFrame(r, w, h) {
              var iframe = window.parent["iframe" + r];
              if (iframe) {
                $(iframe).css("width", w);
                $(iframe).css("height", h);
              }
          };

    function fOptionSelectedEvent(opt) {
      return function () {
        opt.setLocation("SELECTED");
        var ev = new tda.model.OptionSelectedEvent();
        ev.setOption([opt]);
        tda.model.submit(ev);
      };
    }

    function executeRefreshOptionsCommand(cmd) {

      var ee = cmd.environmentEngine[0];
      cmd.delete();

      if (!ee || !(ee.option))
        return;

      var activeFrameRef = 0;
      if (activeDojoFrame)
        activeFrameRef = parseInt(activeDojoFrame.id.substring(5));

      require(["dojo", "dijit/registry", "dijit/form/DropDownButton", "dijit/TooltipDialog", "dijit/form/Button",
          "dijit/form/RadioButton", "dijit/form/Select", "dojox/form/DropDownSelect", "dojo/domReady!"
        ],
        function (dojo, registry, DropDownButton, TooltipDialog, Button, RadioButton, Select, DropDownSelect) {

          initToolbar();
          //        setTimeout(function() {
          //        setTimeout(function() {

          for (var k = 0; k < ee.option.length; k++) {
            if (ee.option[k].frame && (ee.option[k].frame.length > 0) && (ee.option[k].frame[0].reference !=
                activeFrameRef)) {
              continue; // ignore non-active frames...
            }
            var opt = ee.option[k];
            if (!opt.id)
              opt.setId("option" + opt.reference);
            //            if (registry.byId("option"+opt.reference))
            //              registry.byId("option"+opt.reference).destroyRecursive();

            var processSimpleOption = function (option, container) {
              if (!option.id)
                option.setId("option" + option.reference);
              //              if (registry.byId("option"+option.reference))
              //                registry.byId("option"+option.reference).destroyRecursive();

              if (option.location == "SELECT") {
                var sOptions = [];
                for (var i = 0; i < option.child.length; i++) {
                  if (!option.child[i].id)
                    option.child[i].setId("option" + option.child[i].reference);

                  var selected = option.child[i].location && (option.child[i].location.toUpperCase() == "SELECTED");
                  if (!selected)
                    selected = false;
                  sOptions.push({
                    label: option.child[i].caption,
                    value: option.child[i].id,
                    selected: selected
                  });
                }
                var s = new Select({
                  id: option.id,
                  label: option.caption,
                  name: option.caption,
                  onChange: function (id) {
                    for (var i = 0; i < option.child.length; i++) {
                      if (option.child[i].location == "SELECTED")
                        delete option.child[i].location;
                    }
                    for (var i = 0; i < option.child.length; i++) {
                      if (option.child[i].location == "SELECTED")
                        delete option.child[i].location;
                      if (id == option.child[i].id) {
                        if (!option.child[i].location)
                          option.child[i].location = "SELECTED";
                        fOptionSelectedEvent(option.child[i])();
                        break;
                      }
                    }
                  },
                  options: sOptions
                });

                var label = new dijit.layout.ContentPane({
                  content: option.caption + "&nbsp;"
                });
                label.addChild(s);
                label.startup();
                container.addChild(label);
                s.startup();
              } else
              if (option.location == "RADIO") {
                /*var sOptions = [];
                for (var i=0; i<option.child.length; i++) {
                  if (!option.child[i].id)
                    option.child[i].setId("option"+option.child[i].reference);

                  var selected = option.child[i].location && (option.child[i].location.toUpperCase()=="SELECTED");
                  if (!selected)
                	  selected = false;
                  console.log("option "+option.child[i].caption+" selected="+selected);
                  sOptions.push({label:option.child[i].caption, value:option.child[i].id,
                                 selected:selected});
                }
                var s = new DropDownSelect({
                    id: option.id,
                    label: option.caption,
                    name: option.caption,
                    onChange: function(id){
                    	console.log("SELECT CHANGE");
                      for (var i=0; i<option.child.length; i++) {
                        if (option.child[i].location == "SELECTED")
                          delete option.child[i].location;
                      }
                      for (var i=0; i<option.child.length; i++) {
                        if (option.child[i].location == "SELECTED")
                          delete option.child[i].location;
                        if (id == option.child[i].id) {
                          if (!option.child[i].location)
                            option.child[i].location = "SELECTED";
                          fOptionSelectedEvent(option.child[i])();
                          break;
                        }
                      }
                    },
                    options: sOptions
                });
                */

                var label = new dijit.layout.ContentPane({
                  content: option.caption + "&nbsp;"
                });
                //                  label.addChild(s);
                label.startup();
                container.addChild(label);
                //                  s.startup();


                for (var i = 0; i < option.child.length; i++) {

                  if (!option.child[i].id)
                    option.child[i].setId("option" + option.child[i].reference);


                  var selected = option.child[i].location && (option.child[i].location.toUpperCase() == "SELECTED");
                  if (!selected)
                    selected = false;


                  //                      var childi = option.child[i];
                  //                      var fchildi = fOptionSelectedEvent(childi);

                  var label = new dijit.layout.ContentPane({
                    //                        content: "<div id='"+option.child[i].id+"'></div>",
                    content: "&nbsp;&nbsp;&nbsp;&nbsp;<div id='" + option.child[i].id + "'></div>&nbsp;" +
                      option.child[i].caption
                  });
                  label.startup();
                  container.addChild(label);
                  var radioOne = new RadioButton({
                    childi: option.child[i],
                    fchildi: fOptionSelectedEvent(option.child[i]),
                    checked: selected,
                    //                          value: "caption"+i,
                    name: option.id, // group id
                    onChange: function (id) {
                      if (id == true) {
                        setTimeout(function (childi, fchildi) {
                          childi.setLocation("SELECTED");
                          fchildi();
                        }, 10, this.childi, this.fchildi);
                      } else
                        this.childi.setLocation("");
                    }
                  }, option.child[i].id);
                  //                      label.addChild(radioOne);
                  //                      label.set("content", "&nbsp;&nbsp;&nbsp;&nbsp;"+label.get("content")+"&nbsp;"+option.child[i].caption);
                  radioOne.startup();

                  //label.addChild(radioOne);
                  //label.addChild("ABC");

                }


              } else
              if (option.location == "LABEL") {
                var label = new dijit.layout.ContentPane({
                  content: option.caption
                });
                label.startup();
                container.addChild(label);
                for (var i = 0; i < option.child.length; i++)
                  processSimpleOption(option.child[i], container);
              } else { // BUTTON
                var b = new Button({
                  label: option.caption,
                  onClick: fOptionSelectedEvent(option),
                  iconClass: "iconClassFor_" + option.id
                }, option.id);
                var image = option.image;
                if (!image && (container == toolbar)) {
                  image = "TDA_OPTION.png";
                }

                if (image) {
                  b.iconClass = "iconClassFor_" + option.id;

                  var img = new Image();
                  img.src = 'images/' + image;
                  img.onload = function () {
                    styles.innerHTML += "\
                         .iconClassFor_" + option.id + " {\
                           background-image:  url(images/" + image + ");\
                           background-size: 100% auto;\
                           width: " + (img.width * 20 / img.height) + "px;\
                           height: 20px;\
                           text-align: center;\
                           vertical-align: middle;\
                         }";

                    b.startup();
                  };
                } else
                  b.startup();
                container.addChild(b);
              }
            }; // processSimpleOption

            if (opt.location.toUpperCase() == "RIBBON") {
              var myDialog = new TooltipDialog({
                content: ""
              });

              var myButton = new DropDownButton({
                label: opt.caption,
                dropDown: myDialog
              });
              toolbar.addChild(myButton);
              for (var i = 0; i < opt.child.length; i++)
                processSimpleOption(opt.child[i], myDialog);
            } else {
              processSimpleOption(opt, toolbar);
            }
          } // for k
          //       }, 0); // setTimeout
          //       }, 0); // setTimeout
        });

    }


    var toolbar = null;
    var mainLayout;
    var appLayout;
    var centerContainer;
    var leftContainer;
    var rightContainer;
    var topContainer;
    var bottomContainer;
    //    <!-- DOJO LAYOUT -->


    require(["/webappos.js", "dojo", "dojo/dom", "dijit/registry", "dijit/popup", "dijit/form/DropDownButton",
        "dijit/TooltipDialog", "dijit/layout/BorderContainer", "dijit/layout/TabContainer",
        "dojox/layout/ContentPane", "dijit/Dialog", "dijit/Toolbar", "dijit/form/Button", "dijit/form/TextBox",
        "dojo/domReady!"
      ],

      function (x, dojo, dom, registry, popup, DropDownButton, TooltipDialog, BorderContainer, TabContainer,
        ContentPane, Dialog, Toolbar, Button, TextBox) {
        // create the BorderContainer and attach it to our appLayout div

        window.initToolbar = function () {
          if (window.toolbarCreated) {
            if (registry.byId(toolbar.id))
              registry.byId(toolbar.id).destroyRecursive(false);
            //             return;
          }
          window.toolbarCreated = true;
          window.toolbar = new Toolbar({
            region: "top",
            style: "padding:0; margin:0;",
            splitter: false
          });

          if (!webappos.parent_desktop) {
            var launcherButton = new Button({
              id: "launcherButton",
              label: "",
              onClick: function () {
                webappos.desktop.show_launcher('launcherButton');
              },
              iconClass: "launcherIcon"
            });
            toolbar.addChild(launcherButton);


            var logoutButton = new Button({
              id: "eeUserMenuButton",
              label: "",
              onClick: function () {
                webappos.desktop.show_user_menu("eeUserMenuButton");
              },
              iconClass: "userMenuIcon",
              style: "float:right;"
            });

            logoutButton.iconClass = "userMenuIcon";

            var closeButton = new Button({
              id: "eeCloseButton",
              label: "", //"Close",
              onClick: function () {
                webappos.close_current_project();
              },
              iconClass: "closeIcon",
              style: "float:right;" + (webappos.project_id ? "display:block;" : "display:none;")
            });


            closeButton.iconClass = "closeIcon";
            window.toolbar.addChild(logoutButton);
            window.toolbar.addChild(closeButton);

          }

          // project_id label is for in-desktop and out-of-desktop modes:
          var project_id_label = new ContentPane({
            id: "project_id_label",
            content: "<div id='project_id_div'>" + webappos.project_id + "</div>",
            style: "float:right;" + (webappos.project_id ? "display:block;" : "display:none;") +
              "margin-top:4px;margin-right:4px;",
            onClick: function () {
              var new_project_id = webappos.project_id;
              if (new_project_id.indexOf(webappos.login + "/") != 0)
                return; // don't allow to change project_id-s of other users;
              // this will also be checked at the server-side

              for (;;) {
                new_project_id = prompt("Enter new project id", new_project_id);
                if (!new_project_id)
                  return;
                if (new_project_id == webappos.project_id)
                  return;

                var ret1 = window.webappos.webcall_and_wait("webappos.fileExists", new_project_id);
                if (ret1 && ret1.result) {
                  if (!confirm("Project " + new_project_id + " exists. Overwrite?"))
                    continue;
                }

                var ret2 = window.webappos.webcall_and_wait("webappos.renameActiveProject", {
                  project_id: webappos.project_id,
                  new_project_id: new_project_id
                });

                if (ret2.result) {
                  // OK, renamed project_id will be synced via web socket
                } else
                if (ret2.error)
                  alert("Error renaming: " + ret2.error);
                return;
              }

            },
          });
          window.toolbar.addChild(project_id_label);
          mainLayout.addChild(toolbar);

          window.toolbar.startup();
        };

        mainLayout = new BorderContainer({
          region: "top",
          //          design: "headline"
        }, "mainLayout");


        appLayout = new BorderContainer({
          region: "center",
          style: "padding:0; margin:0;",
          //          design: "headline"
        });


        // create the TabContainer
        centerContainer = new TabContainer({
          region: "center",
          id: "centerContainer",
          tabPosition: "top",//"bottom",
          "class": "centerPanel"
        });

        leftContainer = new TabContainer({
          region: "left",
          id: "leftContainer",
          tabPosition: "left",
          "class": "edgePanel",
          splitter: true
        });

        rightContainer = new TabContainer({
          region: "right",
          id: "rightContainer",
          tabPosition: "right",
          "class": "edgePanel",
          splitter: true
        });

        topContainer = new TabContainer({
          region: "top",
          id: "topContainer",
          tabPosition: "top",
          "class": "edgePanel",
          splitter: true
        });

        bottomContainer = new TabContainer({
          region: "bottom",
          id: "bottomContainer",
          tabPosition: "bottom",
          "class": "edgePanel",
          splitter: true
        });

        // add the TabContainer as a child of the BorderContainer
        appLayout.addChild(centerContainer);
        appLayout.addChild(leftContainer);
        appLayout.addChild(rightContainer);
        appLayout.addChild(topContainer);
        appLayout.addChild(bottomContainer);

        hideContainer(centerContainer);
        hideContainer(leftContainer);
        hideContainer(rightContainer);
        hideContainer(topContainer);
        hideContainer(bottomContainer);

        // start up and do layout

        mainLayout.addChild(appLayout);

        mainLayout.startup();
        initToolbar();

        document.title = webappos.app_displayed_name;

        webappos.request_scopes("webappos_scopes", "project_id").then(function () {


          // redefining webappos.set_project_id to update the displayed project name
          webappos.set_project_id = function (new_project_id) {
              // inherited code:
              if (webappos.project_id == new_project_id)
                  return;

              webappos.project_id = new_project_id;
              webappos.js_util.update_query_value("project_id", new_project_id);

              // new code:
              var d_el = dijit.byId("project_id_label");
              if (d_el)
                d_el.domNode.style.visibility = 'visible';
              var div_el = document.getElementById("project_id_div");
              if (div_el)
                div_el.innerHTML = new_project_id;
          };

          let arr=Object.keys(webmem.Frame.getAllObjects());
          for (let i=0;i<arr.length;i++) {
            console.log("deleting frame "+arr[i]);
            webmem[arr[i]].delete();
          }

          arr=Object.keys(webmem.Option.getAllObjects());
          for (let i=0;i<arr.length;i++) {
            console.log("deleting option "+arr[i]);
            webmem[arr[i]].delete();
          }

          if (!webmem.EnvironmentEngine.getFirstObject()) {
            let e = new webmem.EnvironmentEngine();
          }

          initToolbar(); // make the close button visible

          let event = new tda.model.ProjectOpenedEvent();
          tda.model.submit(event);
        });
      });

    function executeShowInformationBarCommand(cmd) {

      require(["dijit/Toolbar", "dijit/form/Button", "dojox/layout/ContentPane", "dojo/domReady!"],
        function (Toolbar, Button, ContentPane) {

          var messageBar = new Toolbar({
            region: "bottom",
            style: "background-color:#FFFFE0; padding:0; margin-bottom:-50;",
            splitter: false
          });

          var pane = new ContentPane({
            //        href: contentURI,  // -- this would be needed when not using iframes
            content: cmd.message + "&nbsp;",
            region: "left",
            style: "float:left; left:0; background-color:#FFFFE0;"
          });
          messageBar.addChild(pane);

          var closeButton2 = new Button({
            label: "Close",
            onClick: function () {
              try {
                mainLayout.removeChild(messageBar);
                messageBar.destroy();
              } catch (t) {}
            },
            iconClass: "closeIcon",
            style: "float:right; background-color:#FFFFE0;"
          });

          closeButton2.iconClass = "closeIcon";
          messageBar.addChild(closeButton2);
          mainLayout.addChild(messageBar);
          messageBar.startup();
          setTimeout(function () {
            try {
              mainLayout.removeChild(messageBar);
              messageBar.destroy();
            } catch (t) {}
          }, 5000);
          //         messageBar.show();
        });

      /*      require(["dojox/widget/UpgradeBar", "dojo/domReady!"],
            function(UpgradeBar) {
              if (upgradeBar) {
                upgradeBar.destroy();
              }
              upgradeBar = new UpgradeBar({
                notifications:[
                {
                    validate:function(){
                      return true;
                    }, 
                    message: cmd.message
                }
                ],
                style:"top:0px;position:absolute;",
              });
              upgradeBar.show();
      console.log(upgradeBar);
            });*/
    }
  </script>

</head>

<body id="body" class="webappos" background="checked_background.png">
  <div id="mainLayout" style="padding:0; margin:0; height:100%">
  </div>

</body>

</html>